from typing import List
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from sqlalchemy import select

from src.server.db.session import get_session
from src.server.models import Quote, QuoteLine, Customer

router = APIRouter(prefix="/quotes", tags=["quotes"])

# ----- LIST (3 vägar): "", "/", "/__list" -----
def _list_quotes_impl(skip: int, limit: int, session: Session):
    # VIKTIGT: använd scalars().all() så vi får riktiga Quote-objekt
    quotes = session.exec(
        select(Quote).offset(skip).limit(limit)
    ).scalars().all()

    out: List[dict] = []
    for q in quotes:
        cust_name = None
        if getattr(q, "customer_id", None) is not None:
            cust = session.get(Customer, q.customer_id)
            cust_name = cust.name if cust else None
        out.append({
            "id": q.id,
            "title": getattr(q, "title", f"Offert #{q.id}"),
            "customer_name": cust_name,
            "subtotal_sek": getattr(q, "subtotal_sek", 0),
            "rot_discount_sek": getattr(q, "rot_discount_sek", 0),
            "total_sek": getattr(q, "total_sek", 0),
        })
    return out

@router.get("", summary="Lista alla offerter")
@router.get("/", include_in_schema=False)
def list_quotes(
    skip: int = Query(0, ge=0),
    limit: int = Query(50, ge=1, le=200),
    session: Session = Depends(get_session),
):
    return _list_quotes_impl(skip=skip, limit=limit, session=session)

@router.get("/__list", summary="Lista alla offerter (failsafe)")
def list_quotes_failsafe(
    skip: int = Query(0, ge=0),
    limit: int = Query(50, ge=1, le=200),
    session: Session = Depends(get_session),
):
    return _list_quotes_impl(skip=skip, limit=limit, session=session)

# ----- GET BY ID (läggs sist så den inte skuggar statiska vägar) -----
@router.get("/{quote_id}", summary="Hämta sparad offert med rader")
def get_quote(quote_id: int, session: Session = Depends(get_session)):
    quote = session.get(Quote, quote_id)
    if not quote:
        raise HTTPException(status_code=404, detail="Offerten hittades inte")

    cust_name = None
    if getattr(quote, "customer_id", None):
        cust = session.get(Customer, quote.customer_id)
        cust_name = getattr(cust, "name", None) if cust else None

    # VIKTIGT: även här .scalars().all() så vi får riktiga QuoteLine-objekt
    lines = session.exec(
        select(QuoteLine).where(QuoteLine.quote_id == quote_id)
    ).scalars().all()

    return {
        "id": quote.id,
        "title": quote.title,
        "customer_name": cust_name,
        "subtotal_sek": quote.subtotal_sek,
        "rot_discount_sek": quote.rot_discount_sek,
        "total_sek": quote.total_sek,
        "lines": [
            {
                "kind": l.kind,
                "ref": l.ref,
                "description": l.description,
                "qty": l.qty,
                "unit_price_sek": l.unit_price_sek,
                "line_total_sek": l.line_total_sek,
            }
            for l in lines
        ],
    }
